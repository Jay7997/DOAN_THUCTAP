<!DOCTYPE html>
<html>
<head>
    <title>Test Comments</title>
    <meta name="csrf-token" content="test-token">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Test Comments System</h1>
    
    <form id="comment-form">
        <div>
            <label for="comment-name">Name:</label>
            <input type="text" id="comment-name" required>
        </div>
        <div>
            <label for="comment-rating">Rating:</label>
            <select id="comment-rating" required>
                <option value="100">5 stars</option>
                <option value="80">4 stars</option>
                <option value="60">3 stars</option>
                <option value="40">2 stars</option>
                <option value="20">1 star</option>
            </select>
        </div>
        <div>
            <label for="comment-content">Comment:</label>
            <textarea id="comment-content" required></textarea>
        </div>
        <button type="submit">Submit Comment</button>
    </form>
    
    <div id="comments-list"></div>
    
    <script>
        $(document).ready(function() {
            var productId = 60001; // Test product ID
            
            // Load comments
            loadComments();
            
            // Function to load comments
            function loadComments(page = 1) {
                $.get(`/api/proxy-binhluan/${productId}/${page}`)
                    .done(function(data) {
                        console.log('Comments data:', data);
                        var commentsData = [];
                        if (Array.isArray(data) && data.length > 0 && Array.isArray(data[0].data)) {
                            commentsData = data[0].data;
                        }
                        renderComments(commentsData);
                    })
                    .fail(function(xhr, status, error) {
                        console.log('Error loading comments:', error);
                        $('#comments-list').html('<p>Error loading comments</p>');
                    });
            }
            
            // Function to render comments
            function renderComments(comments) {
                var html = '';
                if (comments.length === 0) {
                    html = '<p>No comments yet.</p>';
                } else {
                    comments.forEach(function(comment) {
                        var stars = '';
                        var rating = comment.rating ? comment.rating / 20 : 0;
                        for (var i = 1; i <= 5; i++) {
                            if (i <= rating) {
                                stars += '⭐';
                            } else {
                                stars += '☆';
                            }
                        }
                        
                        html += `
                        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                            <div><strong>${comment.nguoidang || 'Anonymous'}</strong> - ${comment.ngaydang ? new Date(comment.ngaydang).toLocaleDateString() : ''}</div>
                            <div>${stars}</div>
                            <div>${comment.noidungbinhluan || ''}</div>
                        </div>
                        `;
                    });
                }
                $('#comments-list').html(html);
            }
            
            // Handle form submission
            $('#comment-form').submit(function(e) {
                e.preventDefault();
                
                var name = $('#comment-name').val();
                var rating = $('#comment-rating').val();
                var content = $('#comment-content').val();
                
                $.ajax({
                    url: `/api/proxy-binhluan/${productId}/add`,
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    data: JSON.stringify({
                        nguoidang: name,
                        rating: rating,
                        noidungbinhluan: content
                    })
                })
                .done(function(data) {
                    alert('Comment submitted successfully!');
                    $('#comment-form')[0].reset();
                    loadComments(); // Reload comments
                })
                .fail(function(xhr, status, error) {
                    console.log('Error submitting comment:', xhr, status, error);
                    alert('Error submitting comment: ' + xhr.responseText);
                });
            });
        });
    </script>
</body>
</html>